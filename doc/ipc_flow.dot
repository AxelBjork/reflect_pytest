digraph IPC {
  rankdir=LR;
  bgcolor="#0F172A";
  pad=0.15;
  // Slightly increase vertical separation (rankdir=LR => nodesep affects vertical spacing)
  nodesep=0.45;
  ranksep=0.55;
  splines=spline;

  fontname="Helvetica,Arial,sans-serif";
  fontsize=52;
  fontcolor="#F1F5F9";
  label=<<B>System Architecture and Message Flow</B>>;
  labelloc="t";

  node [
    fontname="Helvetica,Arial,sans-serif",
    shape=rect,
    style="filled,rounded",
    fixedsize=false,
    margin="0.12,0.08",
    fontsize=28,
    fontcolor="#FFFFFF",
    penwidth=4,
    color="#F1F5F9"
  ];

  edge [
    fontname="Helvetica,Arial,sans-serif",
    fontsize=24,
    fontcolor="#CBD5E1",
    color="#64748B",
    penwidth=3.0,
    arrowsize=1.4,
    labelfloat=false,
    labeldistance=0.8,
    labelangle=20
  ];

  // --- Simulator ---
  subgraph cluster_sim {
    label=<<B><FONT POINT-SIZE="40">Simulator</FONT></B>>;
    fontcolor="#F1F5F9";
    style="rounded,filled";
    color="#475569";
    penwidth=4;
    fillcolor="#1E293B";
    margin=34;

    LogService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">LogService</FONT></B><BR/><FONT POINT-SIZE="24">Asynchronous logging sink.</FONT>>
    ];

    UdpBridge [
      fillcolor="#0F766E",
      label=<<B><FONT POINT-SIZE="38">UdpBridge</FONT></B><BR/><FONT POINT-SIZE="26">Message Distribution Hub</FONT>>
    ];

    MotorService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">MotorService</FONT></B><BR/><FONT POINT-SIZE="24">Executes motor command sequences.</FONT>>
    ];
    KinematicsService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">KinematicsService</FONT></B><BR/><FONT POINT-SIZE="24">Simulates vehicle motion.</FONT>>
    ];
    PowerService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">PowerService</FONT></B><BR/><FONT POINT-SIZE="24">Models battery and load.</FONT>>
    ];
    StateService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">StateService</FONT></B><BR/><FONT POINT-SIZE="24">System state and simulation clock.</FONT>>
    ];
    ThermalService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">ThermalService</FONT></B><BR/><FONT POINT-SIZE="24">Thermal management.</FONT>>
    ];
    EnvironmentService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">EnvironmentService</FONT></B><BR/><FONT POINT-SIZE="24">Environmental data.</FONT>>
    ];
    AutonomousService [
      fillcolor="#0369A1",
      label=<<B><FONT POINT-SIZE="30">AutonomousService</FONT></B><BR/><FONT POINT-SIZE="24">High level driving logic.</FONT>>
    ];

    // Encourage LogService to sit left of the hub
    LogService -> UdpBridge [style=invis, weight=10];
  }

  // --- Network Layer bounding box (TX/RX) ---
  subgraph cluster_sockets {
    label=<<B><FONT POINT-SIZE="40">Network Layer</FONT></B>>;
    fontcolor="#F1F5F9";
    style="rounded,filled";
    color="#F59E0B";
    penwidth=6;
    fillcolor="#2A1B07";
    margin=24;

    TX [
      fillcolor="#B45309",
      label=<<B><FONT POINT-SIZE="30">TX Socket</FONT></B><BR/><FONT POINT-SIZE="24">Port 9000 (SIL Inbound)</FONT>>
    ];
    RX [
      fillcolor="#B45309",
      label=<<B><FONT POINT-SIZE="30">RX Socket</FONT></B><BR/><FONT POINT-SIZE="24">Port 9001 (SIL Outbound)</FONT>>
    ];

    // In rankdir=LR, this invisible edge nudges TX above RX (reduces edge crossings).
    TX -> RX [style=invis, weight=50];
  }

  // --- Test Harness bounding box ---
  subgraph cluster_fixtures {
    label=<<B><FONT POINT-SIZE="40">Test Harness</FONT></B>>;
    fontcolor="#F1F5F9";
    style="rounded,filled";
    color="#22C55E";
    penwidth=6;
    fillcolor="#0B2A20";
    margin=24;

    TestCase [
      fillcolor="#047857",
      label=<<B><FONT POINT-SIZE="34">Test Case / Fixtures</FONT></B>>
    ];
  }

  // Flow: Test Harness -> Network -> Simulator
  TestCase -> TX [label="send_msg", color="#F1F5F9", penwidth=5];
  TX -> UdpBridge [label="Inbound Traffic", color="#F1F5F9", penwidth=5];

  // Internal Simulator Logic
  UdpBridge -> {MotorService KinematicsService PowerService ThermalService EnvironmentService AutonomousService StateService} [label="Dispatch", style=dashed];
  {MotorService KinematicsService PowerService ThermalService EnvironmentService AutonomousService StateService} -> UdpBridge [label="Publish", style=dashed];

  // Logging is publish-only
  LogService -> UdpBridge [label="Publish", style=dashed];

  StateService -> {MotorService KinematicsService PowerService ThermalService AutonomousService} [label="PhysicsTick", color="#475569", penwidth=1.8];

  // Flow: Simulator -> Network -> Test Harness
  // Keep Test Harness on the left (rank constraint TestCase -> RX), while drawing the arrow
  // from RX back into TestCase.
  RX -> UdpBridge [label="Outbound Traffic", color="#F1F5F9", penwidth=5, dir=back, arrowtail=normal];
  TestCase -> RX [label="recv_msg", color="#F1F5F9", penwidth=5, dir=back, arrowtail=normal];
}